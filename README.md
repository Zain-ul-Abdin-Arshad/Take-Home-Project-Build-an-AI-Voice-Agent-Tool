# AI Voice Agent Tool for Logistics

A functional web application that allows a non-technical administrator to configure, test, and review calls made by an adaptive AI voice agent for logistics operations.

## Technology Stack
- **Frontend**: React + Vite + Tailwind CSS
- **Backend**: FastAPI (Python)
- **Database**: Supabase (PostgreSQL + API)
- **Voice AI**: Retell AI

## Core Features

### 1. Agent Configuration UI
- Simple interface for administrators to define prompts and logic
- Advanced settings for Retell AI voice configuration (backchanneling, filler words, interruption sensitivity)
- Support for conversation flow parameters and emergency keywords

### 2. Call Triggering & Results UI
- **Driver Information Input**: Name, phone number, and load number fields
- **Start Test Call Button**: Triggers voice agent calls with proper context
- **Structured Results Display**: Key-value pairs showing collected information
- **Full Transcript Viewing**: Complete call transcripts with scrollable interface

### 3. Backend Logic
- **Webhook Handler**: Processes Retell AI callbacks and transcripts
- **Real-time Processing**: Interprets prompts from database to guide conversations
- **Post-processing**: Structures raw transcripts into actionable summaries
- **Dynamic Response Handling**: Manages uncooperative drivers and noisy environments

### Setup

1) Clone the repository
```
git clone <your-repo-url>
cd <repo>
```

2) Environment variables
- Copy `.env.example` to `.env` and fill values:
  - `SUPABASE_URL`
  - `SUPABASE_KEY` (service role for server-side access)
  - `RETELL_API_KEY`
  - `WEBHOOK_BASE_URL` (your public domain for webhook callbacks)
  - Optional: `RETELL_BASE_URL` (defaults to `https://api.retellai.com`)

3) Backend (FastAPI)
```
python -m venv .venv
. .venv/Scripts/activate  # Windows PowerShell: .venv\Scripts\Activate.ps1
pip install -r requirements.txt
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 | cat
```
Health check: `GET http://localhost:8000/health`

Create Supabase tables (SQL editor):
```sql
create table if not exists public.agent_config (
  id bigint generated by default as identity primary key,
  name text not null,
  prompt text not null,
  settings jsonb not null default '{}'::jsonb,
  created_at timestamptz not null default now()
);

create table if not exists public.call_logs (
  id bigint generated by default as identity primary key,
  driver_name text not null,
  phone_number text not null,
  load_number text not null,
  transcript text,
  structured_summary jsonb,
  external_call_id text,
  config_id bigint references public.agent_config(id) on delete set null,
  created_at timestamptz not null default now()
);
```

4) Frontend (React)
```
cd frontend
npm install
npm run dev
```
App runs at `http://localhost:3000`. API requests to `/api/*` proxy to `http://localhost:8000` (see `frontend/vite.config.js`).

5) Configure Webhook URL
- For production: Set `WEBHOOK_BASE_URL` to your deployed domain
- For development: Use ngrok or similar to expose your local server:
  ```bash
  # Install ngrok
  npm install -g ngrok
  
  # Expose local server
  ngrok http 8000
  
  # Use the https URL in your .env
  WEBHOOK_BASE_URL=https://your-ngrok-url.ngrok.io
  ```

### Usage Guide

1) Create Retell AI Agent
- Go to [retellai.com](https://retellai.com) and create a new agent
- Configure voice settings, prompts, and conversation flow
- Copy the Agent ID from your Retell dashboard

2) Configure Agent in App
- Go to `Agent Config` page and create a config with:
  - **Name**: Descriptive name for your agent
  - **Prompt**: The conversation prompt for the agent
  - **Settings**: JSON with your Retell Agent ID:
    ```json
    {
      "retell_agent_id": "your_retell_agent_id_here",
      "voice_settings": {
        "voice_id": "default",
        "speed": 1.0,
        "backchanneling": true,
        "filler_words": true,
        "interruption_sensitivity": 0.5
      }
    }
    ```

3) Start a Real Call
- Go to `Dashboard` and enter driver details:
  - **Driver Name**: e.g., "Mike"
  - **Phone Number**: e.g., "+1234567890" 
  - **Load Number**: e.g., "7891-B"
- Select your configured agent and click `Start Test Call`
- The system will make a real call using Retell AI

4) View Results
- `Call Results` shows all calls with structured summaries and full transcripts
- As Retell posts to `/webhook`, transcripts are automatically parsed and updated

### Backend API (high level)
- `POST /config` upserts an agent config.
- `GET /config/{id}` fetches a config.
- `POST /start-call` triggers a Retell call and logs it.
- `POST /webhook` receives transcripts and updates `call_logs` with a structured summary.
- `POST /webhook/test` parses a transcript (no DB write).
- `GET /webhook/examples` returns example payloads.

## Implemented Scenarios

### Scenario 1: Logistics - Driver Check-in ("Dispatch")
**Context**: Agent calls driver about specific load (e.g., Mike, Load #7891-B)
**Goal**: Determine driver status through open-ended questioning
**Structured Data Collected**:
- `call_outcome`: "In-Transit Update" OR "Arrival Confirmation"
- `driver_status`: "Driving" OR "Delayed" OR "Arrived"
- `current_location`: (e.g., "I-10 near Indio, CA")
- `eta`: (e.g., "Tomorrow, 8:00 AM")

### Scenario 2: Logistics - Emergency Protocol ("Dispatch")
**Context**: Driver interrupts with emergency during routine check
**Goal**: Immediately pivot to emergency response and gather critical information
**Structured Data Collected**:
- `call_outcome`: "Emergency Detected"
- `emergency_type`: "Accident" OR "Breakdown" OR "Medical" OR "Other"
- `emergency_location`: (e.g., "I-15 North, Mile Marker 123")
- `escalation_status`: "Escalation Flagged"

### Special Cases Handled
- **Uncooperative Driver**: Detects short responses and probes for information
- **Noisy Environment**: Handles garbled speech-to-text with retry logic

## Design Choices

### Technology Selection
- **FastAPI**: Modern Python framework with excellent type hints, automatic API documentation, and high performance
- **Supabase**: Managed PostgreSQL with real-time capabilities, built-in authentication, and easy JSON storage
- **React + Vite**: Fast development experience with modern tooling and excellent developer ergonomics
- **Tailwind CSS**: Utility-first CSS framework for rapid, consistent UI development
- **Retell AI**: Purpose-built voice AI platform with advanced conversation management features

### Architecture Decisions
- **Modular Backend**: Separated concerns with routes, controllers, and services for maintainability
- **Structured Data Processing**: Regex-based parsing with fallback patterns for robust transcript analysis
- **Mock Implementation**: Allows testing without external API dependencies during development
- **Key-Value Display**: Clear, scannable format for administrators to quickly assess call outcomes

## Known Limitations
- **Parsing Method**: Uses keyword/regex-based parsing rather than advanced NLP (can be enhanced with OpenAI)
- **Authentication**: Basic implementation; production would need proper user management
- **Error Handling**: Simplified error responses; production would need comprehensive error management

### Webhook Example Payloads
```json
{
  "call_id": "rt-12345",
  "transcript": "Hi, I've arrived at the destination and unloading now.",
  "metadata": {"driver": "John Doe", "load_number": "LD-001"}
}
```

```json
{
  "call_id": "rt-11223",
  "transcript": "I had a tire blowout, I'm stuck near Main Street. ETA delayed.",
  "metadata": {"driver": "Alex Lee", "load_number": "LD-004"}
}
```

### Development
- Format/lint using your preferred tools.
- Add tests as needed.

## Environment Variables

Create a `.env` file at the project root (see `.env.example`):

```
SUPABASE_URL=
SUPABASE_KEY=
RETELL_API_KEY=
RETELL_BASE_URL=https://api.retellai.com
WEBHOOK_BASE_URL=https://your-domain.com
OPENAI_API_KEY=
OPENAI_MODEL=gpt-4o-mini

# Gemini (preferred)
GEMINI_API_KEY=
GEMINI_MODEL=gemini-1.5-flash
```

## Demo Video

Add your unlisted demo video link here: [Demo Video Placeholder](https://example.com)

## Unified Run Instructions

Backend:
```
python -m venv .venv
. .venv/Scripts/activate
pip install -r requirements.txt
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 | cat
```

Supabase SQL (run in Supabase SQL editor):
```sql
create table if not exists public.agent_config (
  id bigint generated by default as identity primary key,
  name text not null,
  prompt text not null,
  settings jsonb not null default '{}'::jsonb,
  created_at timestamptz not null default now()
);

create table if not exists public.call_logs (
  id bigint generated by default as identity primary key,
  driver_name text not null,
  phone_number text not null,
  load_number text not null,
  transcript text,
  structured_summary jsonb,
  external_call_id text,
  config_id bigint references public.agent_config(id) on delete set null,
  created_at timestamptz not null default now()
);
```

Frontend:
```
cd frontend
npm install
npm run dev
```


